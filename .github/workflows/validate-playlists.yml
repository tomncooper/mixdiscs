name: Validate Playlists

on:
  pull_request:
    paths:
      - 'mixdiscs/*/*.yaml'

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup Python environment
        uses: ./.github/actions/setup-python-env
        with:
          fetch-depth: 0  # Need full history to compare changes
      
      - name: Get changed playlist files
        id: changed-files
        run: |
          CHANGED_FILES=$(./scripts/get_changed_playlists.sh origin/${{ github.base_ref }})
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "files=" >> $GITHUB_OUTPUT
            echo "count=0" >> $GITHUB_OUTPUT
          else
            echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT
            echo "count=$(echo $CHANGED_FILES | wc -w)" >> $GITHUB_OUTPUT
          fi
      
      - name: Validate playlists
        if: steps.changed-files.outputs.count != '0'
        env:
          SPOTIPY_CLIENT_ID: ${{ secrets.SPOTIPY_CLIENT_ID }}
          SPOTIPY_CLIENT_SECRET: ${{ secrets.SPOTIPY_CLIENT_SECRET }}
        run: |
          FILES="${{ steps.changed-files.outputs.files }}"
          uv run python app.py validate config.yaml --files $FILES --update-cache
      
      - name: Commit cache updates
        if: success() && steps.changed-files.outputs.count != '0'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .playlist_cache/playlists_cache.json
          if git diff --staged --quiet; then
            echo "No cache changes to commit"
          else
            git commit -m "chore: update playlist cache [skip ci]"
            git push
          fi
      
      - name: Comment PR with results
        if: failure() && steps.changed-files.outputs.count != '0'
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå Playlist validation failed. Please check the workflow logs for details.'
            })
